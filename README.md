# 取り数最適化システム

元板から製品を効率的に切り出す配置計算アプリケーション

**Current Version: v1.5.1**

## 📋 概要

ノムラ合成株式会社向けに開発された、元板から製品を最適に配置・切り出すための計算システムです。
**Maximal Rectangles + 遺伝的アルゴリズム（GA）** を使用して、材料の無駄を最小限に抑え、歩留まり率を最大化します。

### 主な機能

- ✅ 元板サイズと製品情報を入力
- ✅ **端材（余り材）の活用機能**
  - 既存の端材を優先的に使用して製品を配置
  - 端材消費モード / 全体最適モードの選択
  - グリッド配置による効率的な端材活用
  - 削減コストの自動計算
- ✅ **手動調整機能** 🆕
  - ドラッグ&ドロップによる製品配置の調整
  - 仮置き場を介したパターン間での製品移動
  - Undo/Redo機能
  - リアルタイム歩留まり再計算
- ✅ **2段階最適化アルゴリズム** 🆕
  - Stage 1で最小元板枚数を決定
  - Stage 2で目的に応じた再編成（歩留まり優先/スペース優先）
- ✅ 自動配置計算（回転対応）
- ✅ 遺伝的アルゴリズム（GA）による最適化
- ✅ グリッド配置（同じサイズの製品を格子状に配置）
- ✅ 最適化目標の選択（歩留まり優先 / 余りスペース優先 / 歩留まり再編成 / スペース再編成）
- ✅ 配置図の視覚的表示（パターン間ナビゲーション付き）
- ✅ 同じパターンのグループ化
- ✅ 歩留まり率とコスト計算（詳細歩留まり表示）
- ✅ 印刷機能（端材対応）
- ✅ インライン編集（製品・端材をテーブル内で直接編集）

## 🚀 技術スタック

- **フレームワーク**: [Next.js 15](https://nextjs.org/) (App Router)
- **言語**: [TypeScript](https://www.typescriptlang.org/)
- **スタイリング**: [Tailwind CSS](https://tailwindcss.com/)
- **デプロイ**: [Vercel](https://vercel.com/)

## 📦 セットアップ

### 必要要件

- Node.js 18.0.0以上
- npm または yarn

### インストール

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開いてアプリケーションを確認できます。

## 💡 使い方

### 基本的な流れ

1. **元板設定**: 元板の幅、高さ、単価を入力
2. **カット設定**: カット幅と余白を設定
3. **製品追加**: 製品名、サイズ、数量、色を入力して追加
4. **計算実行**: 「計算実行」ボタンをクリック
5. **結果確認**: 配置図とパターン一覧を確認
6. **印刷**: 必要に応じて印刷プレビューから印刷

### プリセット機能

テスト用のプリセットデータを読み込むことができます。プリセットボタンをクリックすると、サンプルデータが自動的に読み込まれます。

### 配置図の見方

- **パターンID**: A, B, C... で識別
- **枚数**: 同じパターンの元板の枚数
- **歩留まり率**: 有効面積に対する使用面積の割合
- **配置図**: 製品の配置を視覚的に表示（回転も表示）

## 🛠️ 開発

### 利用可能なスクリプト

```bash
# 開発サーバーの起動
npm run dev

# 本番ビルド
npm run build

# 本番サーバーの起動
npm run start

# ESLintチェック
npm run lint

# ESLintの自動修正
npm run lint:fix

# Prettierフォーマット
npm run format

# Prettierチェック
npm run format:check

# TypeScriptの型チェック
npm run type-check
```

### コードフォーマット

このプロジェクトでは、Prettier と ESLint を使用してコード品質を保っています。
Git commit時に自動的にフォーマットが適用されます（Husky + lint-staged）。

## 📁 プロジェクト構造

```
cut-optimizer/
├── docs/                      # ドキュメント
│   ├── torikazu_app_requirements_v1.0.md  # 要件定義書
│   ├── architecture.md        # システムアーキテクチャ
│   ├── data-flow.md           # データフロー設計
│   ├── ui-ux-design.md        # UI/UX設計
│   └── algorithm-details.md   # アルゴリズム詳細仕様
│
├── src/
│   ├── app/                   # Next.js App Router
│   │   ├── page.tsx           # メインページ
│   │   ├── layout.tsx         # ルートレイアウト
│   │   ├── globals.css        # グローバルスタイル
│   │   └── print.css          # 印刷用スタイル
│   │
│   ├── components/            # Reactコンポーネント
│   │   ├── ui/                # 共通UIコンポーネント (Button, Input, Card, etc.)
│   │   ├── forms/             # 入力フォーム関連
│   │   ├── results/           # 結果表示関連
│   │   ├── print/             # 印刷機能関連
│   │   └── layout/            # レイアウトコンポーネント
│   │
│   ├── lib/                   # ビジネスロジック
│   │   ├── algorithm/         # 配置計算アルゴリズム
│   │   │   ├── guillotine.ts  # メインアルゴリズム
│   │   │   ├── placement.ts   # 配置判定ロジック
│   │   │   ├── sort.ts        # ソート処理
│   │   │   ├── pattern.ts     # パターングループ化
│   │   │   ├── yield.ts       # 歩留まり計算
│   │   │   └── __tests__/     # ユニットテスト
│   │   └── presets.ts         # プリセットデータ
│   │
│   └── types/                 # TypeScript型定義
│       ├── config.ts          # 設定関連の型
│       ├── item.ts            # 製品関連の型
│       ├── algorithm.ts       # アルゴリズム関連の型
│       └── result.ts          # 計算結果関連の型
│
├── public/                    # 静的ファイル
└── scripts/                   # スクリプト
```

## 📖 ドキュメント

詳細な設計書は `docs/` ディレクトリを参照してください：

- [要件定義書](./docs/torikazu_app_requirements_v1.0.md) - システムの要件と仕様
- [アーキテクチャ設計書](./docs/architecture.md) - システム構成と技術選定
- [データフロー設計書](./docs/data-flow.md) - データの流れとロジック
- [UI/UX設計書](./docs/ui-ux-design.md) - 画面設計とインタラクション
- [アルゴリズム詳細仕様書](./docs/algorithm-details.md) - 実装の詳細仕様

## 🎯 開発方針

### MVP思考

v1.0は「動くこと」を最優先し、実家で使えることを目標としています。

- 荒くても実用的に
- フィードバックを重視
- 段階的な改善

### Phase別開発

開発は10のPhaseに分かれており、すべて完了しました：

- ✅ **Phase 1**: プロジェクト設計・技術設計
- ✅ **Phase 2**: 開発環境セットアップ
- ✅ **Phase 3**: 型定義・データ構造の実装
- ✅ **Phase 4**: アルゴリズム実装
- ✅ **Phase 5**: UI基本構造の実装
- ✅ **Phase 6**: 入力フォーム・設定画面の実装
- ✅ **Phase 7**: 結果表示・配置図の実装
- ✅ **Phase 8**: 印刷機能の実装
- ✅ **Phase 9**: テスト・デバッグ
- ✅ **Phase 10**: デプロイ・リリース準備

詳細は [development-plan.md](./docs/development-plan.md) を参照してください。

## 🐛 トラブルシューティング

### よくある問題

**問題**: `npm run dev`が起動しない
**解決**: `node_modules`を削除して再インストール

```bash
rm -rf node_modules package-lock.json
npm install
```

**問題**: 型エラーが発生する
**解決**: TypeScriptの型チェックを実行

```bash
npm run type-check
```

## 📝 ライセンス

このプロジェクトはプライベートプロジェクトです。

## 👥 開発者

- **開発**: こうへい
- **対象企業**: ノムラ合成株式会社

---

## 📝 更新履歴

### v1.5.1 (2025-12-22)

**2段階最適化アルゴリズム** ✅

**実装機能**:

- 2段階最適化フレームワーク（two-stage-optimizer.ts）
  - Stage 1: Maximal Rectanglesで最小元板枚数を決定
  - Stage 2: 目的に応じた再編成（製品総数・元板枚数を維持）
- 歩留まり優先モード（reorganize-yield.ts）
  - N-1枚の歩留まり最大化
  - 最後の元板は調整用として柔軟に対応
  - 複数回試行による最良解探索
- スペース優先モード（reorganize-space.ts）
  - 端材サイズの最適化
  - 目標端材サイズの自動検出
  - 端材品質スコアリング

**改善**:

- 元板枚数を維持しつつ歩留まり向上
- 端材品質の改善
- 柔軟な最適化戦略の選択

---

### v1.5 (2025-12-19)

**最適化アルゴリズム改善 - 歩留まり目標達成** ✅

**実装機能**:

- 新メトリクス追加
  - 最後のパターンを除いた平均歩留まり計算
  - 最後のパターンの歩留まり取得
  - 85%目標達成判定
- アルゴリズムレベル改善
  - 全ヒューリスティック比較とスコアリング
  - 適応的配置戦略（aggressive/balanced/conservative）
  - 適応的グリッド生成（4次元スコアリング）
  - スペース使用率最適化（best-fit heuristic）
- 歩留まり詳細表示セクション追加

**改善**:

- 最後以外のパターンで85%以上の歩留まり達成を目指す
- ユーザーへの分かりやすいフィードバック（「最適」or「改善可能」表示）
- 全66テストパス（後方互換性維持）

---

### v1.4.2 (2025-12-22)

**UI改善 - インライン編集とナビゲーション** ✅

**実装機能**:

- 製品編集のインライン化
  - ProductFormダイアログを廃止
  - テーブル内で直接編集
  - 色選択を完全自動化（未使用色を自動割り当て）
  - 新規追加行をテーブル最下部に統合
- 端材編集のインライン化
  - OffcutFormダイアログを廃止
  - 製品と同様のインライン編集パターンに統一
- 製品・端材一覧の合計行追加
  - 品種数と総数をテーブルフッターに表示
- パターン配置図のナビゲーション
  - 前/次ボタンの追加
  - 現在位置表示（N / 総数）
- 編集モードの選択状態維持
  - 製品を仮置き場に移動後も選択状態をキープ
  - 仮置き場でも選択製品を強調表示

**改善**:

- ダイアログ不要でスムーズな製品・端材編集
- 自動色割り当てで操作の手間削減
- パターン間のナビゲーションが容易に
- 編集モードでの製品移動がより直感的に

---

### v1.4.1 (2025-12-19)

**手動調整機能 - 基本実装** ✅

**実装機能**:

- EditableResult型定義（Copy-on-Write）
- 編集モード状態管理
- 編集モードツールバー
- 仮置き場UI
- SVG上でのドラッグ&ドロップ実装
- 配置更新・歩留まり再計算
- 製品クリック→仮置き場移動
- パターン切り替え（仮置き場保持）
- 製品数検証
- **Undo/Redo機能の実装**

**改善**:

- 自動配置結果を手動で微調整可能
- パターン間での製品移動が可能
- 製品数の整合性を維持
- 直感的な操作で配置変更

---

### v1.3.1 (2025-12-12)

**歩留まり表示の改善** ✅

**UI改善**:

- 計算結果サマリーに歩留まり表示を復活
- 3つの歩留まりを詳細表示
  - **全体の歩留まり**: すべてのパターン（元板 + 端材）を含む平均
  - **元板のみの歩留まり**: 元板パターンだけの平均
  - **端材のみ（使用分）の歩留まり**: 使用した端材パターンだけの平均
- 材料の使用効率を詳細に把握可能に

---

### v1.3 (2025-12-12)

**端材活用機能 - 材料費削減の実現** ✅

**実装機能**:

- 端材（余り材）配置アルゴリズム
  - 既存の端材を優先的に使用して製品を配置
  - グリッド配置による効率的な端材活用（1×1〜4×4の明示的テスト）
  - Maximal Rectanglesアルゴリズムとの併用
- 端材処理モードの選択
  - **端材消費モード**: 端材ごとに最高歩留まりの製品を選択（端材を優先的に消費）
  - **全体最適モード**: 全体の平均歩留まりを最大化（端材は必要に応じて使用）
- 端材管理機能
  - 端材の手動登録（名前、サイズ、数量）
  - 端材プリセット機能
  - 端材パターンのグループ化
- 端材配置図の表示
  - 端材サイズに対応した配置図の描画
  - 端材パターンのアンバー色表示
- サマリー表示の強化
  - 使用/未使用端材の表示
  - 端材から切り出す製品数の表示
  - 削減コストの自動計算
- 印刷機能の端材対応
  - 端材使用状況の詳細表示
  - 端材パターンも含めた印刷プレビュー

**UI改善**:

- デフォルト設定を最適化（余りスペース優先 + グリッド配置ON）
- 端材処理モード選択を計算実行ブロックに統合
- より直感的な操作フロー

**改善**:

- 既存端材の有効活用により材料費を削減
- 元板使用枚数の削減
- 端材の再利用率向上
- グリッド配置により複数製品を効率的に配置

**今後の課題**:

- 端材生成機能（計算結果から自動生成）- v1.5以降
- 端材の永続化（在庫管理）- v1.5以降

---

### v1.2.1 (2025-12-10)

**UI改善 - 使いやすさの向上** ✅

**UI変更**:

- アルゴリズム選択をアコーディオン形式に変更
  - 選択中のアルゴリズムのみ表示
  - クリックで展開し、Guillotine Cut / Maximal Rectanglesから選択
- 計算実行セクションを結果エリアの上部に移動
  - 複数の設定で計算・比較検討がしやすく
  - アルゴリズム選択、最適化目標、オプションを1箇所に集約
- 計算実行ボタンを大きく、視覚的に目立つように改善

**改善**:

- ユーザーが頻繁に使う機能へのアクセス性向上
- 設定変更→計算→比較のワークフローが自然に
- レイアウトがすっきりして操作しやすく

---

### v1.2 (2025-12-10)

**最適化強化 - GA・グリッド配置・余りスペース最適化** ✅

**実装機能**:

- 遺伝的アルゴリズム（GA）の実装
  - より広い解空間の探索
  - 配置順序とソート戦略の進化的最適化
  - 計算時間約10-20秒で最適解を探索
- グリッド配置機能
  - 同じサイズの製品を格子状に配置
  - 動的グリッド生成（空きスペースに応じて最適なグリッドサイズを選択）
  - 切断作業の効率化
- 最適化目標の強化
  - 歩留まり優先: 材料の無駄を最小化
  - 余りスペース優先: 次回活用しやすい形状の余りを確保
- 余りスペース品質評価
  - 集中度（40%）: 余り矩形の数が少ない方が良い
  - 形状（30%）: 正方形に近い形状が良い
  - サイズ（30%）: 大きな余りスペースが良い
- 配置アルゴリズムの改善
  - バックトラッキング: 新規元板を作る前に既存元板への配置を試行
  - 低歩留まり元板の削減

**改善**:

- 歩留まり率のさらなる向上
- 元板枚数の最適化
- 余りスペースの再活用性向上
- 実用性の大幅な向上

**今後の課題**:

- 手動調整機能（v1.3予定）
- より高度な最適化手法の検討

---

### v1.1 (2025-12-09)

**Maximal Rectangles実装 - 現場最低限レベル達成（MVP）** ✅

**実装機能**:

- Maximal Rectangles アルゴリズムの実装
  - ギロチンカットの制約を撤廃
  - L字型などの複雑な空きスペースを活用
- 4つのヒューリスティックを自動試行
  - Best Short Side Fit（短辺の余り最小）
  - Best Long Side Fit（長辺の余り最小）
  - Best Area Fit（面積の余り最小）
  - Bottom Left（左下優先）
- アルゴリズム選択機能（ギロチン/Maximal Rectangles）

**改善**:

- 歩留まり率が大幅に向上
- 元板枚数の削減
- より実用的な配置パターン
- 現場で使える最低限レベルを達成

**今後の課題**:

- 余りスペースの形状最適化（次回活用しやすい形に）
- 手動調整機能（v1.3予定）

---

### v1.0 (2025-12-03)

**初回リリース** ✅

**実装機能**:

- Guillotine Cut + First Fit Decreasing アルゴリズム
- 元板設定（幅、高さ、単価）
- 切断設定（カット幅、余白）
- 製品入力（名前、サイズ、個数、色）
- 配置計算と結果表示
- パターン一覧と配置図の視覚化
- 印刷機能
- プリセット機能

**成果**:

- 基本的な配置計算が可能
- 直感的なUIで使いやすい
- TypeScriptによる型安全性
- テストカバレッジあり

**課題**:

- 歩留まり率が低い（70-75%）
- ギロチンカットの制約で最適解が見つからないケースあり

---

Generated with [Claude Code](https://claude.com/claude-code)
