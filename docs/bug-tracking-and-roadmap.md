# バグ追跡・管理とロードマップ

**最終更新**: 2025-12-17

## 概要

このドキュメントは、統合テストで発見されたバグの管理と、今後の修正・改善タイミングの指針を提供します。

---

## バグ管理方針

### 優先度分類

| 優先度          | 説明                                         | 対応時期        |
| --------------- | -------------------------------------------- | --------------- |
| **P0 (致命的)** | 機能が正常に動作しない、データ不整合が発生   | 即座に修正      |
| **P1 (高)**     | 重要な機能に影響、ユーザー体験を大きく損なう | v1.5で修正      |
| **P2 (中)**     | 一部機能に影響、回避策が存在する             | v1.6-1.7で修正  |
| **P3 (低)**     | 軽微な問題、改善の余地                       | v1.8+または将来 |

### バグステータス

- 🔴 **Open**: 未修正
- 🟡 **In Progress**: 修正中
- 🟢 **Fixed**: 修正済み
- ⚪ **Verified**: 問題なし（誤検知）
- 🔵 **Deferred**: 将来対応予定

---

## v1.4 手動編集モード - 統合テスト結果

**実施日**: 2025-12-17
**テスト方法**: Exploreエージェントによる体系的コード分析

### 修正済みバグ (🟢 Fixed)

| ID     | 優先度 | 内容                                           | 修正内容                         | コミット |
| ------ | ------ | ---------------------------------------------- | -------------------------------- | -------- |
| **E1** | P0     | ResultSummaryが編集モード中に古いデータを表示  | `editableResult`を渡すように修正 | a68342b  |
| **E2** | P1     | selectedPatternが適用/破棄後にリセットされない | 最初のパターンを自動選択         | a68342b  |
| **E3** | P1     | offcutInfoの浅いコピー問題                     | 明示的なディープコピー実装       | a68342b  |

### 検証済み（問題なし） (⚪ Verified)

| ID     | 内容                               | 調査結果                               |
| ------ | ---------------------------------- | -------------------------------------- |
| **E4** | 仮置き場の数量計算ロジックが不明確 | pattern.count分の追加/削除は正しい設計 |
| **E5** | 数量検証ロジックエラーの疑い       | 論理的に正しく実装されている           |

### 未修正バグ (🔴 Open)

#### P2 (中優先度) - v1.6で対応予定

| ID     | 内容                                                       | 影響                             | 対応予定 |
| ------ | ---------------------------------------------------------- | -------------------------------- | -------- |
| **E6** | オフカットの歩留まり計算で古いパラメータが使用される可能性 | 歩留まり表示が不正確になる可能性 | v1.6     |
| **E7** | 複数回分割時の命名規則が複雑化（A-1-1など）                | UI表示が混乱する可能性           | v1.6     |
| **E8** | baseItemId抽出ロジックが脆弱                               | カスタムIDで動作しない可能性     | v1.6     |

#### P3 (低優先度) - v1.7+で対応予定

| ID      | 内容                                                             | 影響                                         | 対応予定 |
| ------- | ---------------------------------------------------------------- | -------------------------------------------- | -------- |
| **E9**  | 分割後のパターンが親と同じyield値を継承                          | 分割後に他パターンが変更されても更新されない | v1.7     |
| **E10** | 分割されたオフカットパターンの属性が浅いコピー                   | offcutInfo変更時に子にも影響                 | v1.7     |
| **E11** | 新規元板パターンのisOffcutがundefinedのまま                      | 明示的でない（動作上は問題なし）             | v1.7     |
| **E12** | 編集モードでselectedPatternがオフカット⇔元板切り替え時のUI不整合 | 表示ズレの可能性（実際は問題なし）           | v1.7     |
| **E13** | 破棄時に仮置き場の製品喪失に対する警告がない                     | ユーザー体験の改善余地                       | v1.7     |
| **E14** | editableResultの余分なフィールドがresultに含まれる               | メモリ使用量の増加（軽微）                   | v1.8+    |

---

## 他機能の統合テスト結果

### 端材（オフカット）機能

**実施日**: 2025-12-17
**ステータス**: ✅ 完了

#### 発見されたバグ (🔴 Open)

##### P0 (致命的) - v1.5で即座に修正

| ID     | 内容                                  | 影響                                                               | 対応予定 |
| ------ | ------------------------------------- | ------------------------------------------------------------------ | -------- |
| **O1** | ResultSummaryでの端材使用枚数計算誤り | `usedOffcutCount`がパターン数を返す（実際の使用枚数ではない）      | v1.5     |
| **O2** | 端材ID追跡の脆弱性                    | 複数枚端材の展開時にIDが変更され、未使用端材の判定が失敗する可能性 | v1.5     |

##### P1 (高) - v1.5で修正

| ID     | 内容                               | 影響                                                          | 対応予定 |
| ------ | ---------------------------------- | ------------------------------------------------------------- | -------- |
| **O3** | 消費モードと最適化モードの実装重複 | 2つのモードでほぼ同じコードが実行され、機能的な違いが不明確   | v1.5     |
| **O4** | 端材パターンの数量追跡の複雑さ     | `platesUsed`と`pattern.count`の関係が複雑で、集計ミスの可能性 | v1.5     |

##### P2 (中) - v1.6で修正

| ID     | 内容                                   | 影響                                                               | 対応予定 |
| ------ | -------------------------------------- | ------------------------------------------------------------------ | -------- |
| **O5** | 編集モードでの端材パターン編集制限なし | 端材パターンの削除や変更に制約がなく、数量不整合の可能性           | v1.6     |
| **O6** | 端材の余白設定の重複実装               | `margin = pattern.isOffcut ? 0 : cutConfig.margin`が複数箇所で重複 | v1.6     |
| **O7** | プリセットの固定化問題                 | 各プリセット読み込み時に新しいUUIDが生成される                     | v1.6     |

##### P3 (低) - v1.7+で修正

| ID     | 内容                               | 影響                                              | 対応予定 |
| ------ | ---------------------------------- | ------------------------------------------------- | -------- |
| **O8** | 端材歩留まり計算の複数枚扱い曖昧性 | `p.count`が複数枚の場合の歩留まり計算方法が不明確 | v1.7     |

#### 検証すべきケース

1. **複数枚同一端材の部分利用**
   - 端材A（3枚）で製品を2.5枚分配置した場合の集計
2. **モード切り替え時の結果変化**
   - 消費/最適化モードでの結果比較
3. **編集→端材削除→保存**
   - 編集で端材パターンを削除後の製品数量整合性
4. **プリセット複数読み込み**
   - 同じプリセットを複数回読み込んだ場合のID競合

---

### 製品登録機能

**実施日**: 2025-12-17
**ステータス**: ✅ 完了

#### 発見されたバグ (🔴 Open)

##### P1 (高) - v1.5で修正

| ID     | 内容                             | 影響                                                               | 対応予定 |
| ------ | -------------------------------- | ------------------------------------------------------------------ | -------- |
| **P1** | Quantity変更後の計算結果不整合   | 製品数量変更後も古い計算結果が表示され、編集モードで数量検証エラー | v1.5     |
| **P2** | プリセット上書き時の警告なし     | 既存製品が確認なしに全て失われる                                   | v1.5     |
| **P3** | baseItemId抽出ロジックの重複実装 | 3か所で同じ正規表現が重複定義され、保守性が低下                    | v1.5     |

##### P2 (中) - v1.6で修正

| ID     | 内容                         | 影響                                               | 対応予定 |
| ------ | ---------------------------- | -------------------------------------------------- | -------- |
| **P4** | 編集中の製品削除処理が未定義 | 編集中に製品が削除された場合の挙動が未定義         | v1.6     |
| **P5** | 製品削除後の計算結果無効化   | 削除直後は古い計算結果が表示され、手動再計算が必要 | v1.6     |

##### P3 (低) - v1.7+で修正

| ID     | 内容                       | 影響                                                               | 対応予定 |
| ------ | -------------------------- | ------------------------------------------------------------------ | -------- |
| **P6** | 製品ID重複チェック欠落     | UUIDv4の衝突確率は低いが、理論的には重複可能性あり                 | v1.7     |
| **P7** | ページリロード時の状態喪失 | ローカルストレージ未使用のため、リロードで全状態が失われる（仕様） | v1.8+    |

#### 主要な連携フロー

```
ProductForm → handleAddItem → items state → calculate()
    ↓                                           ↓
ProductList                              CalculationResult
    ↓                                           ↓
PresetManager                            EditableResult
                                                ↓
                                         validateQuantities
```

---

### アルゴリズム選択機能

**実施日**: 2025-12-17
**ステータス**: ✅ 完了

#### 発見されたバグ (🔴 Open)

##### P0 (致命的) - v1.5で即座に修正

| ID     | 内容                                | 影響                                                         | 対応予定 |
| ------ | ----------------------------------- | ------------------------------------------------------------ | -------- |
| **A1** | 端材+GAの組み合わせでオプション無視 | 端材配置後の残りアイテム計算時にGA・グリッド設定が強制無効化 | v1.5     |

##### P1 (高) - v1.5で修正

| ID     | 内容                                  | 影響                                                 | 対応予定 |
| ------ | ------------------------------------- | ---------------------------------------------------- | -------- |
| **A2** | GA使用時の'remaining-space'評価不正確 | GA適応度計算で余りスペース品質が正確に計算されない   | v1.5     |
| **A3** | 計算結果に設定メタデータなし          | どの最適化目標で計算したか記録されず、結果比較が困難 | v1.5     |

##### P2 (中) - v1.6で修正

| ID     | 内容                           | 影響                                                                     | 対応予定 |
| ------ | ------------------------------ | ------------------------------------------------------------------------ | -------- |
| **A4** | GA使用時のパフォーマンス問題   | グリッド有効時にGA計算が10-20秒かかる                                    | v1.6     |
| **A5** | 端材モードと最適化目標の不整合 | 'remaining-space'選択時でも端材配置は歩留まり優先される                  | v1.6     |
| **A6** | グリッド選択基準の相違         | 同じ条件でも最適化目標により異なるグリッドが選択され、結果が大きく変わる | v1.6     |

##### P3 (低) - v1.7+で修正

| ID     | 内容                            | 影響                                                                       | 対応予定 |
| ------ | ------------------------------- | -------------------------------------------------------------------------- | -------- |
| **A7** | デフォルト値が'remaining-space' | 'yield'が直感的だが、デフォルトは'remaining-space'でユーザーが無意識に使用 | v1.7     |
| **A8** | 最適化目標のヒント不足          | UIで「どのような結果の違いが出るか」の説明がない                           | v1.7     |
| **A9** | 複数設定結果比較機能なし        | ヒントで「結果を比較検討できます」とあるが、並列比較機能がない             | v1.7     |

#### 最適化目標による主な違い

| 項目                     | 'yield'（歩留まり優先）   | 'remaining-space'（余りスペース優先） |
| ------------------------ | ------------------------- | ------------------------------------- |
| ヒューリスティック優先順 | best-short-side-fit → ... | bottom-left → ...                     |
| グリッド選択基準         | アイテム数最大化          | アスペクト比1に近い（正方形）         |
| 最終評価基準             | averageYield              | remainingSpaceQuality                 |
| 期待される結果           | 使用枚数削減              | 整った形の余り材確保                  |

---

## バージョンごとの修正計画

### v1.5 (次期メジャーアップデート)

**リリース予定**: 未定
**テーマ**: 最適化アルゴリズム改善 + P1バグ修正

#### 予定される修正

**編集モード (v1.4):**

- ✅ E1: ResultSummary不整合（済）
- ✅ E2: selectedPatternリセット（済）
- ✅ E3: offcutInfoディープコピー（済）

**端材機能:**

- O1: ResultSummaryでの端材使用枚数計算修正
- O2: 端材ID追跡ロジックの改善
- O3: 消費/最適化モードの実装整理
- O4: 端材パターン数量追跡の明確化

**製品登録機能:**

- P1: Quantity変更後の計算結果警告追加
- P2: プリセット上書き確認ダイアログ追加
- P3: baseItemId抽出の共通ユーティリティ化

**アルゴリズム選択:**

- A1: 端材+GA組み合わせ時のオプション適用
- A2: GA適応度計算での余りスペース品質改善
- A3: 計算結果へのメタデータ追加

#### 新機能

- 歩留まり優先アルゴリズムの改善
  - 最後のパターンを調整用として扱う
  - 他パターンで85%以上の歩留まりを目指す
- あまりスペース優先アルゴリズムの明確化
  - 端材活用を最初から意識した配置
  - 歩留まりとのバランス調整

#### 参考ドキュメント

- `docs/versions/v1.5-optimization-algorithm-improvements.md`

---

### v1.6 (マイナーアップデート)

**リリース予定**: 未定
**テーマ**: P2バグ修正 + UX改善

#### 予定される修正

**編集モード:**

- E6: オフカット歩留まり計算の正確性向上
- E7: パターン分割命名規則の改善
- E8: baseItemId抽出ロジックの堅牢化

**端材機能:**

- O5: 編集モードでの端材パターン編集制限実装
- O6: 端材余白設定の共通化
- O7: プリセットUUID生成の改善

**製品登録機能:**

- P4: 編集中の製品削除処理の定義
- P5: 製品削除後の計算結果無効化警告

**アルゴリズム選択:**

- A4: GA使用時のパフォーマンス最適化
- A5: 端材モードと最適化目標の整合性改善
- A6: グリッド選択基準の一貫性向上

#### 新機能候補

- Undo/Redo機能（編集モード）
- 製品回転機能（編集モード）
- 端材形状の評価表示

---

### v1.7 (マイナーアップデート)

**リリース予定**: 未定
**テーマ**: P3バグ修正 + ポリッシュ

#### 予定される修正

**編集モード:**

- E9-E14: 低優先度バグの修正

**端材機能:**

- O8: 端材歩留まり計算の複数枚扱い明確化

**製品登録機能:**

- P6: 製品ID重複チェック追加

**アルゴリズム選択:**

- A7: デフォルト値の見直し
- A8: 最適化目標のヒント改善
- A9: 複数設定結果比較UI実装

**共通:**

- パフォーマンス最適化
- メモリ使用量の削減

#### 新機能候補

- マルチ選択（編集モード）
- キーボードショートカット拡張
- 履歴タイムライン表示

---

### v1.8+ (将来)

**リリース予定**: 未定
**テーマ**: 次世代機能

#### 検討中の機能

- 機械学習による配置最適化
- 複数パターンの同時最適化
- 端材データベース連携
- リアルタイムコラボレーション

---

## 統合テストの実施方針

### 定期的な統合テスト

新機能追加時または重要な変更時に、Exploreエージェントを使った統合テストを実施：

1. **機能単体のテスト** (通常の開発・テスト)
2. **統合テスト** (Exploreエージェント)
   - 他機能との連携ポイント分析
   - 潜在的バグの洗い出し
   - データフローの整合性確認
3. **バグ記録** (このドキュメント)
   - 発見されたバグを優先度付け
   - 修正タイミングの決定
4. **修正実装** (適切なバージョンで)

### テスト対象機能

- ✅ 手動編集モード (v1.4) - 完了
- 🟡 端材機能 - 実施中
- 🟡 製品登録機能 - 実施中
- 🟡 アルゴリズム選択機能 - 実施中
- ⬜ サマリー表示機能 - 未実施
- ⬜ プリセット管理機能 - 未実施
- ⬜ 印刷機能 - 未実施
- ⬜ 配置図表示機能 - 未実施

---

## バグ修正の優先順位決定基準

### 1. ユーザー影響度

- データ損失やクラッシュ → P0
- 機能が使えない、結果が不正確 → P1
- 不便だが回避可能 → P2
- 軽微な問題 → P3

### 2. 発生頻度

- 必ず発生 → 優先度+1
- 特定条件で発生 → 優先度維持
- 稀に発生 → 優先度-1

### 3. 修正コスト

- 小規模な変更（1-2ファイル） → すぐ対応
- 中規模な変更（3-5ファイル） → 次バージョン
- 大規模な変更（6+ファイル、設計変更） → 将来

### 4. 関連機能との依存関係

- 他のバグ修正とセットで対応すべき → まとめて対応
- 独立している → 個別対応可能

---

## 変更履歴

### 2025-12-17

- ドキュメント作成
- v1.4手動編集モードの統合テスト結果を記録
- E1-E14のバグを分類・記録
- v1.5-1.7の修正計画を策定

---

## 参考リンク

- [ROADMAP.md](../ROADMAP.md) - プロジェクト全体のロードマップ
- [v1.4設計書](./versions/v1.4-design.md) - 手動編集モード設計
- [v1.5+最適化改善計画](./versions/v1.5-optimization-algorithm-improvements.md) - アルゴリズム改善
