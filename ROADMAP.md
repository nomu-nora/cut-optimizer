# 取り数最適化システム ロードマップ

**プロジェクト**: 取り数最適化システム
**作成日**: 2025年12月4日
**最終更新**: 2025年12月22日

---

## 📍 現在地

**現在のバージョン**: v1.5.1 ✅ (実装完了) + v1.4.2 ✅ (UI改善完了)
**次のバージョン**: v1.4.3 🎯 (手動調整機能の拡張 - 予定)

---

## 🎯 ビジョン

実家の板金工場で実際に使える、高精度で使いやすい取り数最適化システムを構築する。
手作業よりも効率的な配置を自動生成し、材料費とコストを削減する。

---

## 📋 バージョン一覧

### ✅ v1.0 - 基本機能の実装（完了）

**リリース日**: 2025年12月3日

**実装内容**:

- ✅ Guillotine Cut + First Fit Decreasing アルゴリズム
- ✅ 元板設定（幅、高さ、単価）
- ✅ 切断設定（カット幅、余白）
- ✅ 製品入力（名前、サイズ、個数、色）
- ✅ 配置計算
- ✅ 結果表示（パターン一覧、配置図）
- ✅ 印刷機能
- ✅ プリセット機能

**成果**:

- 基本的な配置計算が可能
- UIが完成し、使いやすい
- 型安全性が高い（TypeScript）
- テストカバレッジあり

**課題**:

- 歩留まりが低い（70-75%）
- ギロチンカットの制約で最適解が見つからない
- 手動調整が必要なレベル

**関連ドキュメント**:

- [要件定義書](./docs/torikazu_app_requirements_v1.0.md)
- [アーキテクチャ設計書](./docs/architecture.md)
- [アルゴリズム詳細仕様書](./docs/algorithm-details.md)

---

### ✅ v1.1 - Maximal Rectangles実装（完了）

**リリース日**: 2025年12月9日

**目的**:
ギロチンカットの制約を外し、現場最低限レベルを達成する。

**実装内容**:

- ✅ Maximal Rectangles アルゴリズムの実装
- ✅ 4つのヒューリスティックを自動試行
  - Best Short Side Fit
  - Best Long Side Fit
  - Best Area Fit
  - Bottom Left
- ✅ ギロチンカットとの切り替え機能
- ✅ 回転考慮の改善

**成果**:

- 歩留まり率が大幅に向上
- L字型などの複雑な空きスペースを活用
- 元板枚数の削減
- 現場で使える最低限レベルを達成

**関連ドキュメント**:

- [v1.1設計書](./docs/versions/v1.1-design.md)

---

### ✅ v1.2 - 最適化強化（完了）

**リリース日**: 2025年12月10日

**目的**:
GA・グリッド配置・余りスペース最適化による実用性向上。

**実装内容**:

- ✅ 遺伝的アルゴリズム（GA）の実装
  - 配置順序とソート戦略の進化的最適化
  - より広い解空間の探索
- ✅ グリッド配置機能
  - 同じサイズの製品を格子状に配置
  - 動的グリッド生成（空きスペースに応じた最適化）
- ✅ 最適化目標の強化
  - 歩留まり優先
  - 余りスペース優先
- ✅ 余りスペース品質評価
  - 集中度・形状・サイズの3要素で評価
- ✅ バックトラッキング機能
  - 新規元板作成前に既存元板への配置を試行

**成果**:

- 歩留まり率のさらなる向上
- 元板枚数の最適化
- 余りスペースの再活用性向上
- 実用性の大幅な向上

**関連ドキュメント**:

- [v1.2設計書](./docs/versions/v1.2-design.md)

---

### ✅ v1.2.1 - UI改善（完了）

**リリース日**: 2025年12月10日

**目的**:
使いやすさの向上と設定変更→計算→比較のワークフロー改善。

**実装内容**:

- ✅ アルゴリズム選択をアコーディオン形式に変更
- ✅ 計算実行セクションを結果エリアの上部に移動
- ✅ 計算実行ボタンを大きく、視覚的に目立つように改善
- ✅ 新規コンポーネント（AlgorithmSelector, CalculationControl）

**成果**:

- ユーザーが頻繁に使う機能へのアクセス性向上
- 設定変更→計算→比較のワークフローが自然に
- レイアウトがすっきりして操作しやすく

---

### ✅ v1.3 - 端材活用機能（完了）

**リリース日**: 2025年12月11日

**目的**:
既存の端材（余り材）を優先的に使って製品を配置し、材料費を削減する。

**実装内容**:

- ✅ 端材の手動登録（名前、サイズ、数量）
- ✅ 端材プリセット機能
- ✅ 端材に製品を配置するアルゴリズム
  - グリッド配置（1×1〜4×4の明示的テスト）
  - Maximal Rectanglesアルゴリズムとの併用
- ✅ 端材消費モード / 全体最適モードの切り替え
- ✅ 端材パターンのグループ化
- ✅ 端材配置図の表示
- ✅ サマリー表示（使用/未使用端材、削減コスト計算）

**v1.3.1での改善**:

- ✅ エッジケース修正（空端材、回転処理など）
- ✅ テストカバレッジの向上
- ✅ 型定義の整理
- ✅ コード品質の改善

**成果**:

- 既存端材の有効活用
- 元板使用枚数の削減
- 材料費の削減
- 端材の再利用率向上

**関連ドキュメント**:

- [v1.3設計書](./docs/versions/v1.3-design.md)

**今後の拡張（v1.5以降、データベース実装後）**:

- 端材生成機能（計算結果から自動生成）
- 端材の永続化（在庫管理）
- 端材使用後の残り端材計算

---

### ✅ v1.5 - 最適化アルゴリズム改善（完了）

**リリース日**: 2025年12月19日

**目的**:
歩留まり優先アルゴリズムを改善し、「最後のパターンを除いた全パターンで85%以上の歩留まりを目指す」機能を実装。

**実装内容**:

#### Phase 1: 新メトリクス追加と表示

- ✅ `calculateYieldExcludingLast()` - 最後のパターンを除いた平均歩留まり計算
- ✅ `getLastPatternYield()` - 最後のパターンの歩留まり取得
- ✅ `meetsYieldTarget()` - 85%目標達成判定
- ✅ 歩留まり詳細表示セクション（ResultSummary.tsx）

#### Phase 2: アルゴリズムレベル改善

- ✅ **Step 1**: 全ヒューリスティック比較とスコアリング
- ✅ **Step 2**: 目標達成判定の強化（adaptive strategies）
- ✅ **Step 3**: 適応的グリッド生成（4次元スコアリング）
- ✅ **Step 4**: スペース使用率最適化（best-fit heuristic）

**修正ファイル**:

- `src/types/result.ts` - 4つの新フィールド追加
- `src/lib/algorithm/yield.ts` - 3つの新関数実装
- `src/lib/algorithm/maximal-rectangles.ts` - Phase 2全実装
- `src/lib/algorithm/guillotine.ts` - 新メトリクス統合
- `src/lib/algorithm/offcut-placement.ts` - 新フィールド伝播
- `src/components/results/ResultSummary.tsx` - UI表示追加
- `src/lib/algorithm/__tests__/maximal-rectangles-enhanced.test.ts` - 包括的テスト（新規）

**成果**:

- 最後以外のパターンで85%以上の歩留まり達成を目指す
- 最後のパターンは調整用として柔軟に対応
- ユーザーへの分かりやすいフィードバック（「最適」or「改善可能」表示）
- 適応的な配置戦略（aggressive/balanced/conservative）
- 全66テストパス（後方互換性維持）

**ドキュメント**:

- [v1.5実装ドキュメント](./docs/versions/v1.5-optimization-algorithm-improvements.md)

---

### ✅ v1.5.1 - 2段階最適化アルゴリズム（完了）

**リリース日**: 2025年12月22日

**目的**:
Stage 1で元板枚数を決定した後、Stage 2で配置を再編成し、目的に応じた最適化を行う。

**実装内容**:

- ✅ **2段階最適化フレームワーク**（two-stage-optimizer.ts）
  - Stage 1: Maximal Rectanglesで最小元板枚数を決定
  - Stage 2: 目的に応じた再編成（製品総数・元板枚数を維持）
- ✅ **歩留まり優先モード**（reorganize-yield.ts）
  - N-1枚の歩留まり最大化
  - 最後の元板は調整用として柔軟に対応
  - 複数回試行による最良解探索
- ✅ **スペース優先モード**（reorganize-space.ts）
  - 端材サイズの最適化
  - 目標端材サイズの自動検出
  - 端材品質スコアリング
- ✅ **新型定義**（optimization.ts）
  - OptimizationGoal拡張（'yield-reorganize', 'space-reorganize'）
  - OffcutSize型定義

**成果**:

- 元板枚数を維持しつつ歩留まり向上
- 端材品質の改善
- 柔軟な最適化戦略の選択

**関連ドキュメント**:

- [v1.5実装ドキュメント](./docs/versions/v1.5-optimization-algorithm-improvements.md)

---

### ✅ v1.4 - 手動調整機能（実装中）

**リリース日**: 2025年12月

**目的**:
自動配置結果を手動で微調整できる機能を追加し、より柔軟な配置を可能にする。

#### ✅ v1.4.1 - 基本手動調整機能（完了）

**リリース日**: 2025年12月19日

- ✅ EditableResult型定義（Copy-on-Write）
- ✅ 編集モード状態管理
- ✅ 編集モードツールバー
- ✅ 仮置き場UI
- ✅ SVG上でのドラッグ&ドロップ実装
- ✅ 配置更新・歩留まり再計算
- ✅ 製品クリック→仮置き場移動
- ✅ パターン切り替え（仮置き場保持）
- ✅ 製品数検証
- ✅ **Undo/Redo機能の実装**

#### ✅ v1.4.2 - UI改善（完了）

**リリース日**: 2025年12月22日

**実装内容**:

- ✅ **製品編集のインライン化**
  - ProductFormダイアログを廃止
  - テーブル内で直接編集
  - 色選択を完全自動化（COLOR_PALETTEから未使用色を自動割り当て）
  - 新規追加行をテーブル最下部に統合
- ✅ **端材編集のインライン化**
  - OffcutFormダイアログを廃止
  - 製品と同様のインライン編集パターンに統一
- ✅ **製品・端材一覧の合計行追加**
  - 品種数と総数をテーブルフッターに表示
  - わざわざサマリーセクションを作らずシンプルに
- ✅ **パターン配置図のナビゲーション**
  - 前/次ボタンの追加
  - 現在位置表示（N / 総数）
  - PlacementDiagram と EditablePlacementDiagram の両方に実装
- ✅ **編集モードの選択状態維持**
  - 製品を仮置き場に移動後も選択状態をキープ
  - 別の製品を選ぶまで選択状態が継続
  - 仮置き場でも選択製品を強調表示

**成果**:

- ダイアログ不要でスムーズな製品・端材編集
- 自動色割り当てで操作の手間削減
- パターン間のナビゲーションが容易に
- 編集モードでの製品移動がより直感的に

#### 今後の拡張予定

- [ ] スマートスナップ機能
- [ ] 回転ハンドル
- [ ] マルチ選択
- [ ] コピー&ペースト
- [ ] キーボード微調整（矢印キー）
- [ ] モバイル/タッチ対応

**関連ドキュメント**:

- [v1.4設計書](./docs/versions/v1.4-design.md)

**優先度**: 高

---

### 💡 v1.6 - データベース・材料管理（予定）

**予定リリース日**: 2026年2月以降

**目的**:
データベースを導入し、端材管理・材料管理・プロジェクト保存を実現する。

**実装内容**:

#### データベース基盤

- [ ] Supabaseまたは類似のデータベース導入
- [ ] ユーザー認証・ログイン機能
- [ ] データモデル設計

#### 端材管理の永続化

- [ ] 端材の在庫管理
- [ ] 端材生成機能（計算結果から自動生成）
- [ ] 端材使用後の残り端材計算
- [ ] 端材の編集・削除機能
- [ ] 端材の最小サイズフィルタ

#### 材料管理

- [ ] 材料属性の設定（板厚、色、仕上げ）
- [ ] 製品の優先度設定（急ぎ案件など）
- [ ] 同じ材料属性でグループ化
- [ ] 優先度に応じた配置順序の調整

#### プロジェクト管理

- [ ] プロジェクトの保存・読み込み
- [ ] 履歴管理
- [ ] プロジェクト一覧・検索

**期待される成果**:

- 端材の在庫を管理できる
- 急ぎの仕事を優先配置
- 同じ材料属性の製品を同じ元板に
- プロジェクトを保存して後で編集可能

**優先度**: 高

---

### 🔮 v1.6 - 共有・エクスポート機能（予定）

**予定リリース日**: 2026年3月

**実装内容**:

- [ ] 配置結果の共有（URL）
- [ ] エクスポート機能（CSV、PDF）
- [ ] クラウドストレージ連携
- [ ] 複数ユーザーでのプロジェクト共有

**優先度**: 中

---

### 🌟 v2.0 - AI最適化（構想）

**予定リリース日**: 2026年春

**構想**:

- [ ] 機械学習による配置最適化
- [ ] 過去のデータから学習
- [ ] ユーザーの好みを学習
- [ ] 複数元板のまとめて最適化

**優先度**: 低（研究段階）

---

### 💡 将来の拡張アイデア

#### 厚み対応機能

**背景**:
現在のシステムは2D（幅×高さ）の配置最適化のみを扱っているが、実際の製造では板の厚みも重要な要素。

**実装候補**:

- [ ] **複数厚みの製品対応**
  - 製品ごとに厚みを指定可能に
  - 同じ厚みの製品を同じ元板にグループ化
  - 異なる厚みの元板在庫管理
- [ ] **厚み別の最適化**
  - 厚みごとに最適な配置を計算
  - 厚み変換コスト（例: 厚い板を薄く加工）を考慮
  - 在庫の厚みと必要な厚みのマッチング最適化

**期待される効果**:

- より実際の製造工程に近い最適化
- 材料在庫の効率的な活用
- 厚み変換コストの最小化

**優先度**: 中

#### カット工程効率化

**背景**:
現在は配置最適化（歩留まり最大化）のみだが、実際の作業効率も重要。カットの順序や方法を最適化することで作業時間を短縮できる。

**実装候補**:

- [ ] **カット順序の最適化**
  - カット回数を最小化する順序を計算
  - ギロチンカット制約を考慮した効率的なカット経路
  - カット工具の移動距離を最小化
- [ ] **カット指示書の生成**
  - ステップバイステップのカット手順を出力
  - 各カットの座標と長さを明示
  - 視覚的なカットガイド（アニメーション）
- [ ] **作業時間の推定**
  - カット回数・距離から作業時間を推定
  - 段取り時間を考慮
  - 複数パターンの作業時間比較

**期待される効果**:

- カット作業時間の短縮
- 作業ミスの削減
- 作業者への明確な指示

**優先度**: 中〜高（実用性が高い）

---

## 📊 開発スケジュール

```
2025年12月
├─ 12/1-3   ● v1.0リリース ✅
├─ 12/4-9   ● v1.1開発・リリース ✅
├─ 12/10    ● v1.2, v1.2.1リリース ✅
├─ 12/11    ● v1.3, v1.3.1リリース ✅
└─ 12/16-31 ○ v1.4開発（手動調整機能）

2026年1月
└─ v1.4完成・リリース

2026年2月
└─ v1.5開発（データベース・材料管理）

2026年3月
└─ v1.6開発（共有・エクスポート機能）
```

---

## 🎯 成功基準

### v1.1の成功基準

- ✅ 歩留まり率が現在より5%以上向上
- ✅ Maximal Rectanglesアルゴリズムの実装
- ✅ 全てのテストがパス

### v1.2の成功基準

- ✅ GAとグリッド配置の実装
- ✅ 最適化目標の選択機能
- ✅ 余りスペース品質評価
- ✅ 計算時間が許容範囲内（GA使用時10-20秒）

### v1.3の成功基準

- ✅ 端材の登録・管理機能
- ✅ 端材優先配置アルゴリズム
- ✅ 端材パターンの可視化
- ✅ 削減コストの計算

### v1.4の成功基準（次回目標）

- [ ] ドラッグ&ドロップによる製品移動
- [ ] スマートスナップ機能
- [ ] 仮置き場を介したパターン間移動
- [ ] 製品数の整合性検証
- [ ] 編集内容の適用・破棄

### プロジェクト全体の成功基準

- [ ] 実家で実際に使われている
- [ ] 材料費が10%以上削減
- [ ] 作業時間が短縮
- [ ] ユーザー満足度が高い

---

## 📈 メトリクス

### 測定指標

| 指標                     | v1.0 | v1.1 | v1.2    | v1.3目標 |
| ------------------------ | ---- | ---- | ------- | -------- |
| 平均歩留まり率           | 72%  | 80%+ | 85%+    | 90%+     |
| 計算時間（GAなし）       | 2秒  | 3秒  | 3秒     | 5秒      |
| 計算時間（GAあり）       | -    | -    | 10-20秒 | 10-20秒  |
| 元板枚数（テストデータ） | 5枚  | 4枚  | 3枚     | 3枚      |
| 余り材再利用率           | -    | -    | -       | 50%+     |
| ユーザー満足度           | -    | -    | -       | 80%+     |

---

## 🔧 開発・タスク管理方針

このプロジェクトは一人開発のため、シンプルな管理を重視します。

### タスク管理

- **ローカルのドキュメント**（ROADMAP.md、設計書）で計画を管理
- **Todoツール**は複数ステップがある場合のみ使用（過度な管理は避ける）
- **GitHub Issues**は使用しない
  - 理由: 手作業での移行が面倒、記録するには細かすぎる
  - 共同作業や外部からのフィードバック用に予約

### リリース管理

- **README.mdの更新履歴セクション**でバージョン管理
- リリース時に「何ができるようになったか」を明示
- コミットメッセージを明確に書く

### 原則

- **管理に手間をかけない** - 手が止まる原因を排除
- **シンプルな動線** - 複雑な管理ツールは使わない
- **実装に集中** - ドキュメントは必要最小限

---

## 🚀 次のアクション

### 完了

1. ✅ v1.0リリース（2025-12-03）
2. ✅ v1.1設計・開発・リリース（2025-12-09）
3. ✅ v1.2設計・開発・リリース（2025-12-10）
4. ✅ v1.2.1 UI改善リリース（2025-12-10）

### 今月中（12/16-12/31）

1. ✅ v1.4設計ドキュメントの作成
2. 🎯 v1.4 Phase 1-2の実装（基盤 + ドラッグ&ドロップ）
3. 実家での使用フィードバック収集

### 来月（2026年1月）

1. v1.4 Phase 3-6の実装完了
2. テストとリリース
3. v1.5の設計開始（データベース導入）

---

## 💬 フィードバック

このロードマップは開発の進捗に応じて随時更新されます。
バグ報告や機能要望は、公開後に GitHub Issues で受け付けます。

---

## 🔗 関連リンク

- [GitHub Repository](https://github.com/nomu-nora/cut-optimizer)
- [v1.0要件定義書](./docs/torikazu_app_requirements_v1.0.md)
- [v1.1設計書](./docs/versions/v1.1-design.md)
- [v1.2設計書](./docs/versions/v1.2-design.md)
- [v1.3設計書](./docs/versions/v1.3-design.md)
- [v1.4設計書](./docs/versions/v1.4-design.md)
- [アーキテクチャ設計書](./docs/architecture.md)

---

**最終更新**: 2025年12月22日
**次回更新予定**: v1.4.3実装完了時
