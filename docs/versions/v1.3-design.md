# v1.3 設計書 - 端材利用機能

**プロジェクト**: 取り数最適化システム v1.3
**作成日**: 2025年12月11日
**機能**: 端材（余り材）優先利用機能

---

## 📋 目次

1. [概要](#概要)
2. [背景と目的](#背景と目的)
3. [要件定義](#要件定義)
4. [データ構造](#データ構造)
5. [アルゴリズム設計](#アルゴリズム設計)
6. [UI/UX設計](#uiux設計)
7. [実装計画](#実装計画)
8. [テスト計画](#テスト計画)

---

## 1. 概要

### 1.1 機能概要

**端材（余り材）優先利用機能**は、前回の作業で余った元板（端材）を新規元板よりも優先的に使用する機能です。

### 1.2 主な特徴

- ✅ ユーザーが既存の端材を登録（サイズ・枚数）
- ✅ 端材を優先的に使用して製品を配置
- ✅ 端材で配置できない製品は新規元板で配置
- ✅ 端材の使用状況を可視化
- ✅ 材料費の削減とコスト最適化

### 1.3 期待される効果

- **コスト削減**: 端材を活用することで新規元板の購入を削減
- **環境配慮**: 材料の無駄を最小化
- **在庫管理**: 端材の有効活用で在庫を減らす
- **歩留まり向上**: 全体的な材料使用効率が向上

---

## 2. 背景と目的

### 2.1 背景

現在のシステム（v1.2.1）では、常に新規元板のみを使用して配置計算を行っています。しかし、実際の現場では：

- 前回の作業で余った元板（端材）が在庫として残る
- 端材を活用できれば材料費を削減できる
- 端材の管理と活用が手作業で非効率

### 2.2 目的

端材を優先的に使用することで：

1. **材料費削減**: 新規元板の購入枚数を減らす
2. **在庫最適化**: 端材を効率的に消費
3. **環境負荷軽減**: 材料の無駄を最小化
4. **作業効率化**: 端材活用の計画を自動化

---

## 3. 要件定義

### 3.1 機能要件

#### FR-1: 端材の登録管理

- **FR-1.1**: ユーザーは端材のサイズ（幅×高さ）と枚数を登録できる
- **FR-1.2**: 複数の異なるサイズの端材を登録できる（無制限）
- **FR-1.3**: 端材に名前を付けられる（例: 端材A、端材B）
- **FR-1.4**: 登録した端材を編集・削除できる
- **FR-1.5**: 端材のリストを表示できる

#### FR-2: 端材優先配置

- **FR-2.1**: 端材を面積の小さい順に使用する
- **FR-2.2**: 各端材にできるだけ多くの製品を配置する
- **FR-2.3**: 端材で配置できなかった製品は新規元板で配置する
- **FR-2.4**: 端材への配置は既存のアルゴリズム（Maximal Rectangles / Guillotine Cut）を使用

#### FR-3: 結果表示

- **FR-3.1**: サマリーに端材使用状況を表示
  - 使用した端材の枚数
  - 使用しなかった端材の枚数
- **FR-3.2**: パターン一覧で端材使用パターンを視覚的に区別（🔄アイコン）
- **FR-3.3**: 端材パターンと新規元板パターンを分けて表示
- **FR-3.4**: 各端材の歩留まり率を表示

### 3.2 非機能要件

#### NFR-1: パフォーマンス

- 端材が10枚程度の場合でも計算時間は10秒以内
- GAを使用する場合は20秒以内

#### NFR-2: ユーザビリティ

- 端材の登録は製品入力と同様に直感的
- 結果表示は端材と新規元板の区別が明確

#### NFR-3: 互換性

- v1.2.1の既存機能に影響を与えない
- 端材を登録しない場合は従来通りの動作

### 3.3 制約事項

#### C-1: カット設定

- **v1.3では**: 端材には余白を適用しない（既にカット済みのため）
- **将来**: 端材ごとに余白設定を選べるようにする

#### C-2: 在庫管理

- v1.3では端材の在庫管理機能は実装しない
- 手動で端材を削除・編集する方式

---

## 4. データ構造

### 4.1 型定義

#### OffcutPlate（端材）

```typescript
/**
 * 端材（余り材）の型定義
 */
export interface OffcutPlate {
  /** 端材の一意識別子 */
  id: string

  /** 端材の名前（例: 端材A、端材B） */
  name: string

  /** 幅（mm） */
  width: number

  /** 高さ（mm） */
  height: number

  /** 枚数 */
  quantity: number

  /** 色（配置図で区別するため） */
  color?: string

  /** 余白（mm）- v1.3では未使用、将来的に実装 */
  margin?: number
}
```

#### OffcutUsageInfo（端材使用情報）

```typescript
/**
 * 端材の使用情報
 */
export interface OffcutUsageInfo {
  /** 使用した端材 */
  offcut: OffcutPlate

  /** この端材での配置パターン */
  pattern: PatternGroup

  /** 実際に使用した枚数 */
  platesUsed: number

  /** この端材に配置した製品のID一覧 */
  placedItemIds: string[]
}
```

#### CalculationResult（更新）

```typescript
/**
 * 計算結果（v1.3で拡張）
 */
export interface CalculationResult {
  // 既存のフィールド
  patterns: PatternGroup[]
  totalPlates: number
  averageYield: number
  totalCost: number
  skippedItems: Item[]

  // v1.3で追加
  /** 端材の使用情報 */
  offcutUsage?: {
    /** 使用した端材の情報 */
    used: OffcutUsageInfo[]

    /** 使用しなかった端材 */
    unused: OffcutPlate[]

    /** 端材で配置した製品の合計数 */
    totalItemsOnOffcuts: number

    /** 端材使用による削減コスト */
    costSaved?: number
  }
}
```

### 4.2 データフロー

```
ユーザー入力
  ├─ 元板設定（width, height, unitPrice）
  ├─ 切断設定（cutWidth, margin）
  ├─ 端材リスト（OffcutPlate[]）← v1.3で追加
  └─ 製品リスト（Item[]）

↓ 計算処理

端材優先配置アルゴリズム
  1. 端材を面積順にソート
  2. 各端材に製品を配置
  3. 残った製品を新規元板に配置

↓ 結果

CalculationResult
  ├─ 端材パターン（🔄マーク）
  ├─ 新規元板パターン
  └─ 端材使用情報（used, unused）
```

---

## 5. アルゴリズム設計

### 5.1 全体フロー

```typescript
function calculateWithOffcuts(
  plateConfig: PlateConfig,
  cutConfig: CutConfig,
  items: Item[],
  offcuts: OffcutPlate[],
  algorithm: AlgorithmType,
  optimizationGoal: OptimizationGoal,
  useGA: boolean,
  useGridGrouping: boolean
): CalculationResult {
  // 1. 端材を面積順にソート（小さい順）
  const sortedOffcuts = sortOffcutsByArea(offcuts)

  // 2. 端材に製品を配置
  const offcutResults = placeOnOffcuts(
    sortedOffcuts,
    items,
    cutConfig,
    algorithm,
    optimizationGoal,
    useGA,
    useGridGrouping
  )

  // 3. 残った製品を新規元板に配置
  const remainingItems = getRemainingItems(items, offcutResults)
  const newPlateResults = calculate(
    plateConfig,
    cutConfig,
    remainingItems,
    algorithm,
    optimizationGoal,
    useGA,
    useGridGrouping
  )

  // 4. 結果を統合
  return mergeResults(offcutResults, newPlateResults, offcuts)
}
```

### 5.2 端材ソートアルゴリズム

```typescript
/**
 * 端材を面積の小さい順にソート
 */
function sortOffcutsByArea(offcuts: OffcutPlate[]): OffcutPlate[] {
  return [...offcuts].sort((a, b) => {
    const areaA = a.width * a.height
    const areaB = b.width * b.height
    return areaA - areaB
  })
}
```

**理由**:

- 小さい端材から使うことで、大きな製品が入らない場合に次の端材へ進める
- 大きな端材は後で使う方が、より多くの製品を配置できる可能性が高い

### 5.3 端材配置アルゴリズム

```typescript
/**
 * 端材に製品を配置
 */
function placeOnOffcuts(
  offcuts: OffcutPlate[],
  items: Item[],
  cutConfig: CutConfig,
  algorithm: AlgorithmType,
  optimizationGoal: OptimizationGoal,
  useGA: boolean,
  useGridGrouping: boolean
): OffcutUsageInfo[] {
  const results: OffcutUsageInfo[] = []
  const placedItemIds = new Set<string>()

  for (const offcut of offcuts) {
    // まだ配置されていない製品を取得
    const availableItems = items.filter((item) => !placedItemIds.has(item.id))

    if (availableItems.length === 0) {
      break // すべての製品が配置済み
    }

    // この端材をPlateConfigとして扱う
    const offcutPlateConfig: PlateConfig = {
      width: offcut.width,
      height: offcut.height,
      unitPrice: 0, // 端材はコストなし
    }

    // 端材用のカット設定（余白なし）
    const offcutCutConfig: CutConfig = {
      cutWidth: cutConfig.cutWidth,
      margin: 0, // 端材には余白なし
    }

    // この端材に配置を試行
    const result = calculate(
      offcutPlateConfig,
      offcutCutConfig,
      availableItems,
      algorithm,
      optimizationGoal,
      useGA,
      useGridGrouping
    )

    // 配置できた製品を記録
    for (const pattern of result.patterns) {
      for (const placement of pattern.placements) {
        placedItemIds.add(placement.item.id)
      }
    }

    // この端材での結果を保存
    if (result.patterns.length > 0) {
      results.push({
        offcut,
        pattern: result.patterns[0], // 最初のパターンのみ使用
        platesUsed: Math.min(offcut.quantity, result.patterns[0].count),
        placedItemIds: Array.from(placedItemIds),
      })
    }
  }

  return results
}
```

### 5.4 結果統合アルゴリズム

```typescript
/**
 * 端材結果と新規元板結果を統合
 */
function mergeResults(
  offcutResults: OffcutUsageInfo[],
  newPlateResults: CalculationResult,
  allOffcuts: OffcutPlate[]
): CalculationResult {
  // 使用した端材のID
  const usedOffcutIds = new Set(offcutResults.map((r) => r.offcut.id))

  // 使用しなかった端材
  const unusedOffcuts = allOffcuts.filter((o) => !usedOffcutIds.has(o.id))

  // 端材で配置した製品の合計
  const totalItemsOnOffcuts = offcutResults.reduce((sum, r) => sum + r.placedItemIds.length, 0)

  // 端材パターンに🔄マークを追加
  const offcutPatterns = offcutResults.map((r) => ({
    ...r.pattern,
    isOffcut: true,
    offcutInfo: {
      name: r.offcut.name,
      size: `${r.offcut.width}×${r.offcut.height}`,
    },
  }))

  // パターンを統合（端材が先、新規元板が後）
  const allPatterns = [...offcutPatterns, ...newPlateResults.patterns]

  // 端材使用枚数を計算
  const offcutPlatesUsed = offcutResults.reduce((sum, r) => sum + r.platesUsed, 0)

  return {
    patterns: allPatterns,
    totalPlates: offcutPlatesUsed + newPlateResults.totalPlates,
    averageYield: calculateAverageYield(allPatterns),
    totalCost: newPlateResults.totalCost, // 端材はコストなし
    skippedItems: newPlateResults.skippedItems,
    offcutUsage: {
      used: offcutResults,
      unused: unusedOffcuts,
      totalItemsOnOffcuts,
      costSaved: offcutPlatesUsed * plateConfig.unitPrice,
    },
  }
}
```

---

## 6. UI/UX設計

### 6.1 入力エリア

#### 6.1.1 端材管理セクション

**配置**: 元板設定と切断設定の間

```
┌────────────────────────────────────┐
│ 元板設定                            │
│ 幅: [1820] mm                      │
│ 高さ: [910] mm                     │
│ 単価: [5000] 円                    │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 端材管理 (余り材)                   │ ← v1.3で追加
├────────────────────────────────────┤
│                                    │
│ 端材名 *                           │
│ ┌────────────────────────────────┐ │
│ │ 端材A                          │ │
│ └────────────────────────────────┘ │
│                                    │
│ 幅 (mm) *        高さ (mm) *       │
│ ┌──────────────┐ ┌──────────────┐ │
│ │ 500          │ │ 400          │ │
│ └──────────────┘ └──────────────┘ │
│                                    │
│ 枚数 *                             │
│ ┌────────────────────────────────┐ │
│ │ 2                              │ │
│ └────────────────────────────────┘ │
│                                    │
│        [端材を追加]                 │
│                                    │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 登録済み端材 (3件)                  │
├────────────────────────────────────┤
│                                    │
│ ┌────────────────────────────────┐ │
│ │ 🔄 端材A                       │ │
│ │ サイズ: 500 × 400 mm           │ │
│ │ 枚数: 2枚                      │ │
│ │ 面積: 0.20㎡                   │ │
│ │                  [編集] [削除] │ │
│ └────────────────────────────────┘ │
│                                    │
│ ┌────────────────────────────────┐ │
│ │ 🔄 端材B                       │ │
│ │ サイズ: 800 × 600 mm           │ │
│ │ 枚数: 1枚                      │ │
│ │ 面積: 0.48㎡                   │ │
│ │                  [編集] [削除] │ │
│ └────────────────────────────────┘ │
│                                    │
│           [すべてクリア]            │
│                                    │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 切断設定                            │
│ カット幅: [4] mm                   │
│ 余白: [20] mm                      │
└────────────────────────────────────┘
```

**特徴**:

- 製品入力フォームと同様のデザイン
- 面積を自動計算して表示
- 面積順に並び替えて表示（小さい順）
- 🔄アイコンで端材を視覚的に区別

### 6.2 結果表示エリア

#### 6.2.1 サマリー表示（更新）

```
┌────────────────────────────────────────────────────────┐
│ 計算結果                                               │
├────────────────────────────────────────────────────────┤
│                                                        │
│  【端材使用】                                           │
│  使用: 2枚  未使用: 1枚  削減コスト: ¥10,000          │
│                                                        │
│  【新規元板】                                           │
│  必要枚数: 3枚                                         │
│  総コスト: ¥15,000                                     │
│                                                        │
│  【全体】                                               │
│  平均歩留まり: 87.5%                                   │
│  合計枚数: 5枚 (端材2枚 + 新規3枚)                     │
│                                                        │
└────────────────────────────────────────────────────────┘
```

#### 6.2.2 パターン一覧（更新）

```
┌──────────────────────────────────────────────────────────────┐
│ パターン一覧                                                  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  【端材使用パターン】                                         │
│                                                              │
│  ┌───────────────────┐   ┌───────────────────┐              │
│  │ 🔄 端材A ×2枚     │   │ 🔄 端材B ×1枚     │              │
│  │ (500×400mm)       │   │ (800×600mm)       │              │
│  ├───────────────────┤   ├───────────────────┤              │
│  │                   │   │                   │              │
│  │   [配置図]        │   │   [配置図]        │              │
│  │                   │   │                   │              │
│  ├───────────────────┤   ├───────────────────┤              │
│  │ 歩留まり: 85.2%   │   │ 歩留まり: 90.1%   │              │
│  │ 製品数: 3個       │   │ 製品数: 5個       │              │
│  └───────────────────┘   └───────────────────┘              │
│                                                              │
│  【新規元板パターン】                                         │
│                                                              │
│  ┌───────────────────┐   ┌───────────────────┐              │
│  │ パターンA ×2枚    │   │ パターンB ×1枚    │              │
│  │ (1820×910mm)      │   │ (1820×910mm)      │              │
│  ├───────────────────┤   ├───────────────────┤              │
│  │                   │   │                   │              │
│  │   [配置図]        │   │   [配置図]        │              │
│  │                   │   │                   │              │
│  ├───────────────────┤   ├───────────────────┤              │
│  │ 歩留まり: 87.5%   │   │ 歩留まり: 88.3%   │              │
│  │ 製品数: 8個       │   │ 製品数: 4個       │              │
│  └───────────────────┘   └───────────────────┘              │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**特徴**:

- 端材パターンを上部に表示（🔄アイコン付き）
- 新規元板パターンを下部に表示
- セクションで明確に区別
- 各パターンに製品数を表示

### 6.3 配置図の表示

端材パターンの配置図は、新規元板と同じデザインだが、以下の違いがある：

- **背景色**: 薄い黄色またはベージュ（端材を示す）
- **タイトル**: 「🔄 端材A (500×400mm)」
- **余白表示**: 余白なし（端材は既にカット済み）

---

## 7. 実装計画

### 7.1 Phase 1: データ構造と型定義

**ファイル**: `src/types/offcut.ts`（新規作成）

```typescript
export interface OffcutPlate { ... }
export interface OffcutUsageInfo { ... }
```

**ファイル**: `src/types/result.ts`（更新）

```typescript
export interface CalculationResult {
  // 既存フィールド
  ...
  // 追加フィールド
  offcutUsage?: { ... }
}
```

**所要時間**: 30分

### 7.2 Phase 2: UI - 端材入力

**ファイル**: `src/components/forms/OffcutForm.tsx`（新規作成）

- 端材入力フォーム
- バリデーション
- 面積計算

**ファイル**: `src/components/forms/OffcutList.tsx`（新規作成）

- 登録済み端材リスト
- 編集・削除機能
- 面積順ソート表示

**ファイル**: `src/components/forms/index.ts`（更新）

- エクスポート追加

**ファイル**: `src/app/page.tsx`（更新）

- 端材管理セクション追加
- 端材stateの管理

**所要時間**: 2-3時間

### 7.3 Phase 3: アルゴリズム実装

**ファイル**: `src/lib/algorithm/offcut-placement.ts`（新規作成）

```typescript
export function sortOffcutsByArea(offcuts: OffcutPlate[]): OffcutPlate[]
export function placeOnOffcuts(...)
export function getRemainingItems(...)
export function mergeResults(...)
```

**ファイル**: `src/lib/algorithm/guillotine.ts`（更新）

```typescript
export function calculateWithOffcuts(...)
```

**所要時間**: 3-4時間

### 7.4 Phase 4: UI - 結果表示

**ファイル**: `src/components/results/ResultSummary.tsx`（更新）

- 端材使用情報の表示
- 削減コストの表示

**ファイル**: `src/components/results/PatternGroupList.tsx`（更新）

- 端材パターンと新規元板パターンの分離表示
- 🔄アイコンの追加

**ファイル**: `src/components/results/PlacementDiagram.tsx`（更新）

- 端材配置図の背景色変更
- 余白なし表示

**所要時間**: 2-3時間

### 7.5 Phase 5: テストとデバッグ

- ユニットテスト追加
- 統合テスト
- UI/UXテスト
- バグ修正

**所要時間**: 2-3時間

### 7.6 合計所要時間

**推定**: 10-14時間

---

## 8. テスト計画

### 8.1 ユニットテスト

#### 端材ソート

```typescript
describe('sortOffcutsByArea', () => {
  it('should sort offcuts by area in ascending order', () => {
    const offcuts = [
      { width: 800, height: 600, ... }, // 0.48㎡
      { width: 500, height: 400, ... }, // 0.20㎡
      { width: 1000, height: 500, ... }, // 0.50㎡
    ]
    const sorted = sortOffcutsByArea(offcuts)
    expect(sorted[0].width * sorted[0].height).toBe(200000) // 最小
    expect(sorted[2].width * sorted[2].height).toBe(500000) // 最大
  })
})
```

#### 端材配置

```typescript
describe('placeOnOffcuts', () => {
  it('should place items on offcuts', () => {
    const offcuts = [
      { width: 500, height: 400, quantity: 2, ... }
    ]
    const items = [
      { width: 100, height: 100, quantity: 5, ... }
    ]
    const results = placeOnOffcuts(offcuts, items, ...)
    expect(results).toHaveLength(1)
    expect(results[0].placedItemIds.length).toBeGreaterThan(0)
  })

  it('should not place items if offcut is too small', () => {
    const offcuts = [
      { width: 50, height: 50, quantity: 1, ... }
    ]
    const items = [
      { width: 100, height: 100, quantity: 1, ... }
    ]
    const results = placeOnOffcuts(offcuts, items, ...)
    expect(results).toHaveLength(0)
  })
})
```

### 8.2 統合テスト

#### 端材優先配置フロー

```typescript
describe('calculateWithOffcuts', () => {
  it('should prioritize offcuts over new plates', () => {
    const offcuts = [
      { width: 500, height: 400, quantity: 2, ... }
    ]
    const items = [
      { width: 100, height: 100, quantity: 10, ... }
    ]
    const result = calculateWithOffcuts(
      plateConfig,
      cutConfig,
      items,
      offcuts,
      ...
    )

    expect(result.offcutUsage?.used.length).toBeGreaterThan(0)
    expect(result.patterns.filter(p => p.isOffcut)).toHaveLength(1)
  })

  it('should handle remaining items on new plates', () => {
    const offcuts = [
      { width: 100, height: 100, quantity: 1, ... }
    ]
    const items = [
      { width: 50, height: 50, quantity: 100, ... }
    ]
    const result = calculateWithOffcuts(
      plateConfig,
      cutConfig,
      items,
      offcuts,
      ...
    )

    expect(result.offcutUsage?.used.length).toBe(1)
    expect(result.patterns.filter(p => !p.isOffcut).length).toBeGreaterThan(0)
  })
})
```

### 8.3 UI/UXテスト

#### 手動テストシナリオ

1. **端材登録**
   - [ ] 端材を1件登録できる
   - [ ] 複数の端材を登録できる
   - [ ] バリデーションが正しく動作する
   - [ ] 面積が正しく表示される

2. **端材編集・削除**
   - [ ] 端材を編集できる
   - [ ] 端材を削除できる
   - [ ] すべてクリアが動作する

3. **計算実行**
   - [ ] 端材ありで計算できる
   - [ ] 端材なしで計算できる（従来通り）
   - [ ] 端材使用状況が正しく表示される

4. **結果表示**
   - [ ] 端材パターンと新規元板パターンが区別される
   - [ ] 🔄アイコンが表示される
   - [ ] サマリーに端材情報が表示される
   - [ ] 削減コストが表示される

---

## 9. 将来の拡張

### 9.1 v1.3.1以降で検討する機能

#### 端材ごとの余白設定

```typescript
interface OffcutPlate {
  ...
  margin?: number // 端材ごとに余白を設定
}
```

#### 端材の在庫管理

- 計算後に使用した端材を自動で減らす
- 端材の在庫履歴を記録

#### 端材の優先順位カスタマイズ

- ユーザーがドラッグ&ドロップで優先順位を変更
- 「この端材を優先的に使う」設定

#### 端材のインポート/エクスポート

- CSV形式で端材リストをインポート
- 端材在庫をエクスポート

---

## 10. 参考資料

### 10.1 関連ドキュメント

- [v1.1設計書](./v1.1-design.md) - Maximal Rectangles実装
- [v1.2設計書](./v1.2-design.md) - 最適化強化（GA・グリッド配置）
- [アーキテクチャ設計書](../architecture.md)
- [アルゴリズム詳細仕様書](../algorithm-details.md)

### 10.2 用語集

| 用語       | 説明                                 |
| ---------- | ------------------------------------ |
| 端材       | 前回の作業で余った元板               |
| 余り材     | 端材の別称                           |
| オフカット | 端材の英語表記（Offcut）             |
| 優先配置   | 新規元板よりも端材を先に使用すること |
| 削減コスト | 端材使用により節約できた金額         |

---

**作成**: 2025-12-11
**作成者**: Claude Sonnet 4.5

🤖 Generated with [Claude Code](https://claude.com/claude-code)
