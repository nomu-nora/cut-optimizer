# 開発ワークフロー最適化

**作成日**: 2025年12月26日
**対象プロジェクト**: 取り数最適化システム (cut-optimizer)

---

## 概要

このドキュメントは、MCP・サブエージェント・自動化ツールを統合した効率的な開発ワークフローをまとめたものです。

---

## 現状の課題

### 開発フローの非効率な部分

1. **手動テストに時間がかかる**
   - ブラウザでログイン → 製品入力 → 計算実行 → 結果確認: 約15分
   - 様々なパターンでテストする必要がある

2. **データベース確認が面倒**
   - Supabaseダッシュボードを開く
   - クエリを書く
   - 結果をコピーしてExcelで分析

3. **デバッグに時間がかかる**
   - console.logを大量に追加
   - ブラウザ再起動
   - 手動で操作を再現

4. **デプロイ前の確認漏れ**
   - 型チェック、テスト、ビルドを手動実行
   - 本番環境でのみ発覚するバグ

5. **エラーログの確認が大変**
   - Vercelダッシュボードを開く
   - ログを検索
   - スタックトレースを読み解く

---

## 最適化後のワークフロー

### Phase 1: MCP導入後（今週）

#### データベース操作

**Before**:

```
1. Supabaseダッシュボードを開く
2. SQLエディタを開く
3. クエリを書く: SELECT * FROM calculation_history WHERE user_id = '...'
4. 実行して結果をコピー
→ 5分
```

**After**:

```
> "calculation_historyテーブルの最新10件を表示して"
→ 30秒
```

#### デプロイ確認

**Before**:

```
1. npm run type-check
2. npm run test
3. npm run build
4. git add . && git commit
5. git push
6. Vercelダッシュボードでデプロイ確認
→ 10分
```

**After**:

```
> "型チェック、テスト、ビルドを実行して、問題なければコミット・プッシュして"
→ 2分（自動）
```

---

### Phase 2: サブエージェント導入後（来週〜）

#### デバッグフロー

**Before**:

```
1. console.logを10箇所追加
2. ブラウザ再起動
3. 手動で操作を再現
4. コンソールログを確認
5. console.logを削除
6. もう一度確認
→ 30分
```

**After**:

```
> "デバッグエージェント: GAの計算が遅い。ボトルネックを特定して"
→ 5分（自動分析）
```

#### E2Eテスト

**Before**:

```
1. npm run dev
2. ブラウザでログイン
3. 製品を手動入力（3パターン）
4. 計算実行（各5回）
5. 結果を目視確認
6. スクショして記録
→ 1時間
```

**After**:

```
> "Playwrightで全ての重要フローをテストして"
→ 5分（自動）
```

---

### Phase 3: 完全自動化（1ヶ月後）

#### 機能開発の典型的なフロー

**ゴール**: 「新機能のアイデア」→「本番デプロイ」を1日で完了

**ステップ**:

1. **設計フェーズ（30分）**

   ```
   > "v1.7の新機能『製品の一括インポート機能』を設計して"
   → 設計エージェントが要件定義・設計書を作成
   ```

2. **実装フェーズ（2時間）**

   ```
   > "設計書に基づいて実装して"
   → 実装エージェントがコードを生成
   ```

3. **テストフェーズ（30分）**

   ```
   > "デバッグエージェント: 実装した機能をテストして"
   → 自動でユニットテスト・E2Eテストを実行

   > "Playwrightでインポート機能のE2Eテストを追加して"
   → テストコードを自動生成
   ```

4. **レビューフェーズ（30分）**

   ```
   > "コードレビューエージェント: セキュリティとパフォーマンスをチェックして"
   → 潜在的な問題を指摘
   ```

5. **デプロイフェーズ（10分）**

   ```
   > "型チェック、テスト、ビルドを実行して問題なければデプロイして"
   → 自動でCI/CDパイプラインを実行

   > "デプロイ完了後、Sentryでエラーを監視して"
   → エラーが発生したら即座に通知
   ```

6. **データベース更新（5分）**
   ```
   > "Supabaseに新しいテーブル import_historyを追加するマイグレーションを作成して"
   → マイグレーションファイルを自動生成・実行
   ```

---

## 各フェーズで使うツール

### Phase 1: 基本MCP（今週）

| タスク       | ツール       | 効果       |
| ------------ | ------------ | ---------- |
| DB操作       | Supabase MCP | 5分 → 30秒 |
| Issue管理    | GitHub MCP   | 3分 → 30秒 |
| デプロイ確認 | Vercel MCP   | 10分 → 2分 |

**合計削減時間**: 1日あたり約1時間

---

### Phase 2: サブエージェント（来週〜）

| タスク             | ツール                     | 効果         |
| ------------------ | -------------------------- | ------------ |
| デバッグ           | デバッグエージェント       | 30分 → 5分   |
| E2Eテスト          | Playwright エージェント    | 1時間 → 5分  |
| パフォーマンス分析 | パフォーマンスエージェント | 1時間 → 10分 |

**合計削減時間**: 1日あたり約3時間

---

### Phase 3: 完全自動化（1ヶ月後）

| タスク         | ツール               | 効果         |
| -------------- | -------------------- | ------------ |
| コードレビュー | レビューエージェント | 30分 → 5分   |
| CI/CD          | GitHub Actions + MCP | 20分 → 5分   |
| エラー監視     | Sentry MCP           | 手動確認不要 |

**合計削減時間**: 1日あたり約4時間

---

## 実装ロードマップ

### Week 1: 基本MCP導入

**目標**: データベース操作とGitHub連携を効率化

- [x] Supabase MCP セットアップ
- [x] GitHub MCP セットアップ
- [ ] 実際の開発で試用
- [ ] 効果測定

---

### Week 2: デバッグエージェント

**目標**: デバッグ時間を80%削減

- [ ] デバッグエージェントのスキル作成
- [ ] GA・Maximal Rectanglesのデバッグフローで試用
- [ ] 編集モードのデバッグフローで試用
- [ ] フィードバックを元に改善

---

### Week 3: Playwright E2E

**目標**: 重要フローの自動テスト化

- [ ] Playwright セットアップ
- [ ] 3つの重要フローのテスト作成
  - ログイン → 計算実行
  - 設定変更 → 保存
  - テンプレート保存 → 読み込み
- [ ] ビジュアルリグレッションテスト導入
- [ ] CI/CD統合

---

### Week 4: デプロイ自動化

**目標**: デプロイフローの完全自動化

- [ ] Vercel MCP セットアップ
- [ ] Sentry 導入 + MCP統合
- [ ] 自動デプロイフローの構築
- [ ] エラー監視の自動化

---

### Month 2: 完全自動化

**目標**: 機能開発のリードタイムを50%削減

- [ ] コードレビューエージェント作成
- [ ] パフォーマンス分析エージェント作成
- [ ] データマイグレーションエージェント作成
- [ ] 全エージェントの統合

---

## メトリクス（効果測定）

### 測定指標

| 指標               | 現状    | Phase 1 | Phase 2 | Phase 3 |
| ------------------ | ------- | ------- | ------- | ------- |
| 1機能開発時間      | 3日     | 2.5日   | 1.5日   | 1日     |
| デバッグ時間       | 30分/回 | 30分/回 | 5分/回  | 5分/回  |
| E2Eテスト時間      | 1時間   | 1時間   | 5分     | 5分     |
| デプロイ時間       | 10分    | 5分     | 5分     | 2分     |
| バグ発見までの時間 | 1日     | 1日     | 1時間   | 10分    |

### 目標

- **Phase 1**: 開発時間を20%削減
- **Phase 2**: 開発時間を50%削減
- **Phase 3**: 開発時間を70%削減

---

## ベストプラクティス

### 1. 段階的導入

- 一度に全てを導入せず、1つずつ試す
- 効果を実感できたものだけ残す
- チーム全体で共有

### 2. ドキュメント化

- 新しいツールを導入したらドキュメント更新
- 使い方のサンプルを残す
- トラブルシューティングを記録

### 3. セキュリティ第一

- 認証情報は環境変数で管理
- 本番DBへのアクセスは最小限
- MCPサーバーは信頼できるもののみ

### 4. 定期的な見直し

- 月1回、ツールの使用状況を振り返る
- 使っていないツールは削除
- 新しいニーズに応じて追加

---

## トラブルシューティング

### エージェントが期待通りに動かない

1. スキル定義を確認
2. systemPromptを明確にする
3. 具体的な例を追加

### MCPサーバーが遅い

1. ローカルサーバーを使う（stdio transport）
2. キャッシュを活用
3. 不要なサーバーを削除

### テストが不安定

1. waitForを適切に使う
2. テストデータを固定する
3. テスト環境を分離

---

## 次のステップ

1. [MCP環境構築](./mcp-setup.md)
2. [カスタムサブエージェント設計](./subagents.md)
3. [Playwright E2Eテスト環境構築](./playwright-e2e.md)

---

## 参考資料

- [Claude Code ドキュメント](https://code.claude.com/docs)
- [MCP 公式サイト](https://modelcontextprotocol.io)
- [Playwright 公式ドキュメント](https://playwright.dev/)
- [Sentry Next.js 統合](https://docs.sentry.io/platforms/javascript/guides/nextjs/)

---

**最終更新**: 2025年12月26日
**次回更新予定**: Phase 1 完了時
