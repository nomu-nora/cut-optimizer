# v1.5+ 最適化アルゴリズム改善計画

**バージョン**: v1.5以降（実装時期未定）
**最終更新**: 2025-12-17

## 概要

現在の最適化アルゴリズムを改善し、より実用的な歩留まりと端材活用を実現する。

## 背景

### 現状の課題

#### 歩留まり優先モード

- 最後のパターンのみ余りを詰め込む形になっている
- 最後のパターンを除く他のパターンは82%超えの歩留まりを達成
- 製品サイズを考えるとほぼ使い切っている充填率だが、理想は85%以上

#### あまりスペース優先モード

- 端材活用の意識が弱い
- 歩留まりとのバランスが取りにくい

## 改善方針

### 1. 歩留まり優先アルゴリズムの改善

#### 基本コンセプト

**「最後のパターンを除いた全パターンで85%以上の歩留まりを目指す」**

#### 戦略

```
パターン1: 歩留まり85%以上
パターン2: 歩留まり85%以上
パターン3: 歩留まり85%以上
...
パターンN-1: 歩留まり85%以上
パターンN（最後）: 歩留まり低くても可（調整用）
```

#### 最後のパターンの扱い

- **役割**: 調整用パターン
- **歩留まり**: 低下を許容
- **余りスペースの活用**: 次のカッティングで端材として再利用
- **考え方**: 最後の1枚の余りのみを端材利用に回す

#### 期待される効果

- ほとんどのパターンで高い歩留まり（85%以上）を実現
- 最後のパターンで柔軟に調整可能
- 端材として再利用可能な形状を意識した余りスペース

### 2. あまりスペース優先アルゴリズムの改善

#### 基本コンセプト

**「最初から端材活用を前提とした配置設計」**

#### 戦略

- 全パターンで端材として使いやすい形状を意識
- 余りスペースを最大限再利用可能な形状で残す
- 歩留まりも可能な限り高く保つ

#### 期待される効果

- 端材の再利用率向上
- 長期的な材料コスト削減
- より実用的な配置結果

### 3. 2つのアルゴリズムの明確な違い

| 項目               | 歩留まり優先                | あまりスペース優先       |
| ------------------ | --------------------------- | ------------------------ |
| **基本戦略**       | とにかく歩留まり重視        | 端材活用を最初から意識   |
| **目標歩留まり**   | 最後以外85%以上             | バランスを取りつつ最大化 |
| **最後のパターン** | 調整用（低歩留まり許容）    | 端材として使いやすい形状 |
| **全体的な考え方** | 最後の1枚の余りのみ端材利用 | 全パターンで端材を意識   |
| **適用シーン**     | 高い歩留まりが最優先        | 端材の再利用が重要       |

## 実装方針（案）

### Phase 1: 歩留まり計算ロジックの改善

#### 1. 最後のパターンを除外した歩留まり計算

```typescript
function calculateYieldExcludingLast(patterns: PatternGroup[]): number {
  if (patterns.length <= 1) {
    return patterns[0]?.yield || 0
  }

  const patternsExcludingLast = patterns.slice(0, -1)
  const totalYield = patternsExcludingLast.reduce((sum, p) => sum + p.yield * p.count, 0)
  const totalCount = patternsExcludingLast.reduce((sum, p) => sum + p.count, 0)

  return totalCount > 0 ? totalYield / totalCount : 0
}
```

#### 2. 歩留まり目標の設定

```typescript
interface OptimizationConfig {
  goal: OptimizationGoal
  targetYield?: number // 歩留まり優先時の目標値（デフォルト: 85%）
  allowLastPatternLowYield?: boolean // 最後のパターンの低歩留まりを許容（デフォルト: true）
}
```

### Phase 2: 配置アルゴリズムの改善

#### 歩留まり優先モードの改善

1. **パターン生成時に85%以上を目指す**
   - 配置候補を評価する際、歩留まりを重視
   - 85%未満になる配置は優先度を下げる

2. **最後のパターンの特別扱い**
   - 最後のパターンのみ歩留まり制約を緩和
   - 余りスペースを端材として使いやすい形状に調整

3. **パターン数の最適化**
   - 85%以上を維持できるパターン数を動的に調整
   - 必要に応じてパターン数を増やす

#### あまりスペース優先モードの改善

1. **端材として使える形状の評価**
   - 矩形性の高い余りスペースを優先
   - 最小サイズ制約を考慮

2. **配置順序の最適化**
   - 大きい製品から配置
   - 端材として使いやすい形状を残す配置を優先

### Phase 3: UI改善

#### 結果表示の改善

```typescript
interface OptimizationResult {
  // 既存フィールド
  patterns: PatternGroup[]
  averageYield: number

  // 追加フィールド
  yieldExcludingLast: number // 最後を除いた歩留まり
  lastPatternYield: number // 最後のパターンの歩留まり
  meetsYieldTarget: boolean // 目標歩留まりを達成したか
}
```

#### サマリー表示の拡張

```
歩留まり情報
├── 全体平均: 78.5%
├── 最後を除く平均: 86.2% ✓（目標85%以上達成）
└── 最後のパターン: 45.3%（調整用）
```

## 実装優先度

### High Priority (v1.5)

- [ ] 歩留まり計算ロジックの改善
- [ ] 最後のパターンを除いた歩留まり表示
- [ ] 基本的な配置アルゴリズムの改善

### Medium Priority (v1.6)

- [ ] 端材形状の評価ロジック
- [ ] 配置順序の最適化
- [ ] より詳細なUI表示

### Low Priority (v1.7+)

- [ ] 機械学習を使った配置最適化
- [ ] 複数パターンの同時最適化
- [ ] 端材データベース連携

## 参考情報

### 現状の最適化目標

- `yield-priority`: 歩留まり優先
- `remaining-space`: あまりスペース優先

### 関連ファイル

- `src/lib/algorithm/guillotine.ts` - メインアルゴリズム
- `src/lib/algorithm/placement.ts` - 配置ロジック
- `src/lib/algorithm/sort.ts` - ソートロジック
- `src/lib/utils/yield-calculator.ts` - 歩留まり計算

## 備考

- 実装時期は未定
- ユーザーフィードバックを元に優先順位を調整予定
- アルゴリズムの改善は段階的に実施
